<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring AI RAG ì±—ë´‡</title>
    <style>
        body, html { font-family: 'Google Sans', 'Noto Sans KR', sans-serif; margin: 0; padding: 20px; background-color: #f0f3f6; color: #333; box-sizing: border-box; }
        #main-container { display: flex; width: 100%; max-width: 1200px; height: 90vh; margin: auto; gap: 20px; }
        #sidebar { width: 320px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .sidebar-section { border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .sidebar-section:last-child { border-bottom: none; }
        h3 { margin: 0 0 15px; font-size: 16px; font-weight: 600; }
        .mode-option { display: flex; align-items: center; padding: 10px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .mode-option:hover { background: #f8f9fa; }
        .mode-option.active { border-color: #1a73e8; background: #e8f0fe; }
        .mode-option input { margin-right: 10px; }
        .btn { background-color: #1a73e8; color: #fff; border: none; border-radius: 6px; padding: 10px 16px; font-size: 14px; cursor: pointer; transition: background-color 0.3s; width: 100%; }
        .btn:hover { background-color: #1565c0; }
        .btn-secondary { background-color: #5f6368; }
        .btn-secondary:hover { background-color: #3c4043; }
        #upload-status { font-size: 12px; color: #5f6368; margin-top: 10px; min-height: 20px; }
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #chat-header { padding: 15px 20px; background: #1a73e8; color: #fff; border-radius: 12px 12px 0 0; }
        #chat-header h2 { margin: 0; font-size: 18px; }
        #chat-history { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .message-row { display: flex; margin-bottom: 15px; }
        .message-row.user { justify-content: flex-end; }
        .chat-message { max-width: 70%; padding: 12px 18px; border-radius: 20px; line-height: 1.5; white-space: pre-wrap; }
        .chat-message.user { background: #e6f4ea; color: #202124; border-bottom-right-radius: 4px; }
        .chat-message.ai { background: #e8f0fe; color: #202124; border-bottom-left-radius: 4px; }
        #input-area { display: flex; padding: 15px; border-top: 1px solid #eee; }
        #user-input { flex-grow: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 16px; resize: none; }
        #send-button { background: #1a73e8; color: #fff; border: none; border-radius: 25px; padding: 12px 20px; font-size: 16px; margin-left: 10px; cursor: pointer; }
    </style>
</head>
<body>
<div id="main-container">
    <div id="sidebar">
        <div class="sidebar-section">
            <h3>ğŸ’¬ ì±„íŒ… ëª¨ë“œ</h3>
            <div class="mode-option active" id="mode-rag">
                <input type="radio" name="mode" value="rag" checked>
                <label><strong>RAG ëª¨ë“œ</strong> (ë¬¸ì„œ ê¸°ë°˜ ì‘ë‹µ)</label>
            </div>
            <div class="mode-option" id="mode-llm">
                <input type="radio" name="mode" value="llm">
                <label><strong>ì¼ë°˜ LLM ëª¨ë“œ</strong> (ì§ì ‘ ì‘ë‹µ)</label>
            </div>
        </div>
        <div class="sidebar-section">
            <h3>ğŸ“„ ë¬¸ì„œ ì—…ë¡œë“œ (PDF)</h3>
            <input type="file" id="file-input" accept=".pdf" style="margin-bottom: 10px;">
            <button id="upload-btn" class="btn">ì—…ë¡œë“œ & ì„ë² ë”©</button>
            <div id="upload-status"></div>
        </div>
        <div class="sidebar-section">
            <h3>ğŸ” ë²¡í„° ìŠ¤í† ì–´ ê´€ë¦¬</h3>
            <button id="seed-btn" class="btn btn-secondary" style="margin-bottom: 10px;">í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì¶”ê°€</button>
            <button id="test-search-btn" class="btn btn-secondary">ë²¡í„° ê²€ìƒ‰ í…ŒìŠ¤íŠ¸</button>
        </div>
    </div>
    <div id="chat-container">
        <div id="chat-header">
            <h2>Gemini 2.5 Pro - RAG ì±—ë´‡</h2>
        </div>
        <div id="chat-history"></div>
        <div id="input-area">
            <textarea id="user-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
            <button id="send-button">ë³´ë‚´ê¸°</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
            const chatHistory = document.getElementById('chat-history');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const uploadBtn = document.getElementById('upload-btn');
            const fileInput = document.getElementById('file-input');
            const uploadStatus = document.getElementById('upload-status');
            const modeRag = document.getElementById('mode-rag');
            const modeLlm = document.getElementById('mode-llm');

            // --- ìƒíƒœ ë³€ìˆ˜ ---
            let currentMode = 'rag';
            let isSending = false; // âœ¨ ì¤‘ë³µ ì „ì†¡ ë°©ì§€ë¥¼ ìœ„í•œ í”Œë˜ê·¸

            // --- í•¨ìˆ˜ ì •ì˜ ---
            const updateMode = (newMode) => {
                currentMode = newMode;
                modeRag.classList.toggle('active', newMode === 'rag');
                modeLlm.classList.toggle('active', newMode === 'llm');
                document.querySelector(`input[value="${newMode}"]`).checked = true;
                addSystemMessage(`ëª¨ë“œê°€ ${newMode === 'rag' ? 'RAG' : 'ì¼ë°˜ LLM'}(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            };

            const addMessage = (text, sender) => {
                const messageRow = document.createElement('div');
                messageRow.className = `message-row ${sender}`;
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}`;
                messageDiv.textContent = text;
                messageRow.appendChild(messageDiv);
                chatHistory.appendChild(messageRow);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            };

            const addSystemMessage = (text) => addMessage(text, 'ai');

            const sendMessage = async () => {
                // âœ¨ ì¤‘ë³µ ì „ì†¡ ë°©ì§€ ë¡œì§
                if (isSending) return; 

                const message = userInput.value.trim();
                if (!message) return;

                isSending = true; // ìš”ì²­ ì‹œì‘ ì‹œ í”Œë˜ê·¸ ì„¤ì •
                sendButton.disabled = true;
                addMessage(message, 'user');
                userInput.value = '';

                try {
                    const response = await fetch('/chat/ask', {
                        method: 'POST',
                        body: new URLSearchParams({
                            'userInput': message,
                            'useRag': currentMode === 'rag'
                        })
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const aiResponse = await response.text();
                    addMessage(aiResponse, 'ai');
                } catch (error) {
                    addSystemMessage(`ì˜¤ë¥˜: ${error.message}. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
                } finally {
                    isSending = false; // ìš”ì²­ ì™„ë£Œ ì‹œ í”Œë˜ê·¸ í•´ì œ
                    sendButton.disabled = false;
                    userInput.focus();
                }
            };

            const uploadFile = async () => {
                const file = fileInput.files[0];
                if (!file) {
                    uploadStatus.textContent = 'íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.';
                    return;
                }
                uploadStatus.textContent = 'ì—…ë¡œë“œ ì¤‘...';
                uploadBtn.disabled = true;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/etl/upload', { method: 'POST', body: formData });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    uploadStatus.textContent = `âœ“ ${file.name} ì—…ë¡œë“œ ì™„ë£Œ!`;
                    addSystemMessage(`ë¬¸ì„œ "${file.name}"ì´(ê°€) ë²¡í„° ìŠ¤í† ì–´ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } catch (error) {
                    uploadStatus.textContent = `ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
                } finally {
                    uploadBtn.disabled = false;
                    fileInput.value = '';
                }
            };

            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            uploadBtn.addEventListener('click', uploadFile);
            modeRag.addEventListener('click', () => updateMode('rag'));
            modeLlm.addEventListener('click', () => updateMode('llm'));

            document.getElementById('seed-btn').addEventListener('click', async () => {
                addSystemMessage('í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì¶”ê°€ ì¤‘...');
                const response = await fetch('/vector-store/seed', { method: 'POST' });
                const result = await response.text();
                addSystemMessage(result);
            });

            document.getElementById('test-search-btn').addEventListener('click', async () => {
                const query = prompt('ê²€ìƒ‰í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', 'Spring AI');
                if (!query) return;
                const response = await fetch(`/vector-store/search?q=${encodeURIComponent(query)}`);
                const results = await response.json();
                addSystemMessage(`"${query}" ê²€ìƒ‰ ê²°ê³¼:\n${results.join('\n')}`);
            });

            addSystemMessage('ì•ˆë…•í•˜ì„¸ìš”! RAG ì±—ë´‡ì…ë‹ˆë‹¤. ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ ëª¨ë“œë¥¼ ë³€ê²½í•˜ì—¬ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.');
        });
    </script>
</body>
</html>